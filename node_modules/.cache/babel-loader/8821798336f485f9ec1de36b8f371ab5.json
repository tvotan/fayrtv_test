{"ast":null,"code":"import _regeneratorRuntime from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React from'react';import{Button,Icon}from'semantic-ui-react';import{formatTimestamp,getColorHex,getDefaultPicture,iceServers}from'../../utils';export var VideoChat=/*#__PURE__*/function(_React$Component){_inherits(VideoChat,_React$Component);var _super=_createSuper(VideoChat);function VideoChat(){var _this;_classCallCheck(this,VideoChat);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.ourStream=void 0;_this.videoRefs={};_this.videoPCs={};_this.socket=_this.props.socket;_this.handleSignal=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data){var msg,from,pc,answer;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// Handle messages received from signaling server\nmsg=data.msg;from=data.from;pc=_this.videoPCs[from];console.log('recv',from,data);if(!(msg.ice!==undefined)){_context.next=8;break;}pc.addIceCandidate(new RTCIceCandidate(msg.ice));_context.next=20;break;case 8:if(!(msg.sdp&&msg.sdp.type==='offer')){_context.next=19;break;}_context.next=11;return pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));case 11:_context.next=13;return pc.createAnswer();case 13:answer=_context.sent;_context.next=16;return pc.setLocalDescription(answer);case 16:_this.sendSignal(from,{sdp:pc.localDescription});_context.next=20;break;case 19:if(msg.sdp&&msg.sdp.type==='answer'){pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));}case 20:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.setupWebRTC=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var stream;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return navigator.mediaDevices.getUserMedia({audio:true,video:true});case 2:stream=_context2.sent;_this.ourStream=stream;// alert server we've joined video chat\n_this.socket.emit('CMD:joinVideo');case 5:case\"end\":return _context2.stop();}}},_callee2);}));_this.stopWebRTC=function(){_this.ourStream&&_this.ourStream.getTracks().forEach(function(track){track.stop();});_this.ourStream=undefined;Object.values(_this.videoPCs).forEach(function(pc){pc.close();});_this.videoPCs={};_this.socket.emit('CMD:leaveVideo');};_this.toggleVideoWebRTC=function(){if(_this.ourStream){_this.ourStream.getVideoTracks()[0].enabled=!_this.ourStream.getVideoTracks()[0].enabled;}};_this.getVideoWebRTC=function(){return _this.ourStream&&_this.ourStream.getVideoTracks()[0].enabled;};_this.toggleAudioWebRTC=function(){if(_this.ourStream){_this.ourStream.getAudioTracks()[0].enabled=!_this.ourStream.getAudioTracks()[0].enabled;}};_this.getAudioWebRTC=function(){return _this.ourStream&&_this.ourStream.getAudioTracks()[0]&&_this.ourStream.getAudioTracks()[0].enabled;};_this.updateWebRTC=function(){// TODO teardown connections to people who leave\nif(!_this.ourStream){// We haven't started video chat, exit\nreturn;}_this.props.participants.forEach(function(user){var id=user.id;if(!user.isVideoChat||_this.videoPCs[id]){return;}if(id===_this.socket.id){_this.videoPCs[id]=new RTCPeerConnection();_this.videoRefs[id].srcObject=_this.ourStream;}else{var pc=new RTCPeerConnection({iceServers:iceServers()});_this.videoPCs[id]=pc;// Add our own video as outgoing stream\n//@ts-ignore\npc.addStream(_this.ourStream);pc.onicecandidate=function(event){// We generated an ICE candidate, send it to peer\nif(event.candidate){_this.sendSignal(id,{ice:event.candidate});}};//@ts-ignore\npc.onaddstream=function(event){// Mount the stream from peer\nvar stream=event.stream;// console.log(stream);\n_this.videoRefs[id].srcObject=stream;};// For each pair, have the lexicographically smaller ID be the offerer\nvar isOfferer=_this.socket.id<id;if(isOfferer){pc.onnegotiationneeded=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var offer;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return pc.createOffer();case 2:offer=_context3.sent;_context3.next=5;return pc.setLocalDescription(offer);case 5:_this.sendSignal(id,{sdp:pc.localDescription});case 6:case\"end\":return _context3.stop();}}},_callee3);}));}}});};_this.sendSignal=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(to,data){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:console.log('send',to,data);_this.socket.emit('signal',{to:to,msg:data});case 2:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x2,_x3){return _ref4.apply(this,arguments);};}();return _this;}_createClass(VideoChat,[{key:\"componentDidMount\",value:function componentDidMount(){this.socket.on('signal',this.handleSignal);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.socket.off('signal',this.handleSignal);}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(this.props.rosterUpdateTS!==prevProps.rosterUpdateTS){this.updateWebRTC();}}},{key:\"render\",value:function render(){var _this2=this;var _this$props=this.props,participants=_this$props.participants,pictureMap=_this$props.pictureMap,nameMap=_this$props.nameMap,tsMap=_this$props.tsMap,socket=_this$props.socket;return/*#__PURE__*/React.createElement(\"div\",{style:{display:this.props.hide?'none':'flex',width:'100%',flexDirection:'column',overflow:'auto'}},!this.ourStream&&/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',flexWrap:'wrap'}},/*#__PURE__*/React.createElement(Button,{fluid:true,title:\"Join Video Chat\",color:'purple',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.setupWebRTC},/*#__PURE__*/React.createElement(Icon,{name:\"video\"}),\"Join Video Chat\")),this.ourStream&&/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',flexWrap:'wrap'}},/*#__PURE__*/React.createElement(Button,{fluid:true,color:'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.stopWebRTC},/*#__PURE__*/React.createElement(Icon,{name:\"external\"}),\"Leave\"),/*#__PURE__*/React.createElement(Button,{fluid:true,color:this.getVideoWebRTC()?'green':'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.toggleVideoWebRTC},/*#__PURE__*/React.createElement(Icon,{name:\"video\"}),this.getVideoWebRTC()?'On':'Off'),/*#__PURE__*/React.createElement(Button,{fluid:true,color:this.getAudioWebRTC()?'green':'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.toggleAudioWebRTC},/*#__PURE__*/React.createElement(Icon,{name:this.getAudioWebRTC()?'microphone':'microphone slash'}),this.getAudioWebRTC()?'On':'Off')),/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',flexWrap:'wrap'}},participants.map(function(p){return/*#__PURE__*/React.createElement(\"div\",{key:p.id},/*#__PURE__*/React.createElement(\"div\",{style:{position:'relative'//marginLeft: '4px',\n}},/*#__PURE__*/React.createElement(\"div\",null,_this2.ourStream&&p.isVideoChat?/*#__PURE__*/React.createElement(\"video\",{ref:function ref(el){_this2.videoRefs[p.id]=el;},className:\"videoChatContent\",autoPlay:true,muted:p.id===socket.id,\"data-id\":p.id}):/*#__PURE__*/React.createElement(\"img\",{className:\"videoChatContent\"// broken image: https://ui-avatars.com/api/?name=haidee&background=B03060&size=256&color=ffffff\n,src:pictureMap[p.id]||getDefaultPicture(nameMap[p.id],getColorHex(p.id)),alt:\"\"}),/*#__PURE__*/React.createElement(\"div\",{style:{position:'absolute',bottom:'4px',left:'0px',width:'100%',backgroundColor:'rgba(0,0,0,0)',color:'white',borderRadius:'4px',fontSize:'10px',fontWeight:700,display:'flex'}},/*#__PURE__*/React.createElement(\"div\",{title:nameMap[p.id]||p.id,style:{width:'80px',backdropFilter:'brightness(80%)',padding:'4px',textOverflow:'ellipsis',whiteSpace:'nowrap',overflow:'hidden',display:'inline-block'}},p.isVideoChat&&/*#__PURE__*/React.createElement(Icon,{size:\"small\",name:\"video\"}),nameMap[p.id]||p.id),/*#__PURE__*/React.createElement(\"div\",{style:{backdropFilter:'brightness(60%)',padding:'4px',flexGrow:1,display:'flex',justifyContent:'center'}},formatTimestamp(tsMap[p.id]||0))))));})));}}]);return VideoChat;}(React.Component);","map":{"version":3,"sources":["/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/src/components/VideoChat/VideoChat.tsx"],"names":["React","Button","Icon","formatTimestamp","getColorHex","getDefaultPicture","iceServers","VideoChat","ourStream","videoRefs","videoPCs","socket","props","handleSignal","data","msg","from","pc","console","log","ice","undefined","addIceCandidate","RTCIceCandidate","sdp","type","setRemoteDescription","RTCSessionDescription","createAnswer","answer","setLocalDescription","sendSignal","localDescription","setupWebRTC","navigator","mediaDevices","getUserMedia","audio","video","stream","emit","stopWebRTC","getTracks","forEach","track","stop","Object","values","close","toggleVideoWebRTC","getVideoTracks","enabled","getVideoWebRTC","toggleAudioWebRTC","getAudioTracks","getAudioWebRTC","updateWebRTC","participants","user","id","isVideoChat","RTCPeerConnection","srcObject","addStream","onicecandidate","event","candidate","onaddstream","isOfferer","onnegotiationneeded","createOffer","offer","to","on","off","prevProps","rosterUpdateTS","pictureMap","nameMap","tsMap","display","hide","width","flexDirection","overflow","flexWrap","map","p","position","el","bottom","left","backgroundColor","color","borderRadius","fontSize","fontWeight","backdropFilter","padding","textOverflow","whiteSpace","flexGrow","justifyContent","Component"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Button, Icon } from 'semantic-ui-react';\nimport { Socket } from 'socket.io';\n\nimport {\n  formatTimestamp,\n  getColorHex,\n  getDefaultPicture,\n  iceServers,\n} from '../../utils';\n\ninterface VideoChatProps {\n  socket: Socket;\n  participants: User[];\n  pictureMap: StringDict;\n  nameMap: StringDict;\n  tsMap: NumberDict;\n  rosterUpdateTS: Number;\n  hide?: boolean;\n}\n\nexport class VideoChat extends React.Component<VideoChatProps> {\n  ourStream?: MediaStream;\n  videoRefs: any = {};\n  videoPCs: PCDict = {};\n  socket = this.props.socket;\n\n  componentDidMount() {\n    this.socket.on('signal', this.handleSignal);\n  }\n\n  componentWillUnmount() {\n    this.socket.off('signal', this.handleSignal);\n  }\n\n  componentDidUpdate(prevProps: VideoChatProps) {\n    if (this.props.rosterUpdateTS !== prevProps.rosterUpdateTS) {\n      this.updateWebRTC();\n    }\n  }\n\n  handleSignal = async (data: any) => {\n    // Handle messages received from signaling server\n    const msg = data.msg;\n    const from = data.from;\n    const pc = this.videoPCs[from];\n    console.log('recv', from, data);\n    if (msg.ice !== undefined) {\n      pc.addIceCandidate(new RTCIceCandidate(msg.ice));\n    } else if (msg.sdp && msg.sdp.type === 'offer') {\n      // console.log('offer');\n      await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n      const answer = await pc.createAnswer();\n      await pc.setLocalDescription(answer);\n      this.sendSignal(from, { sdp: pc.localDescription });\n    } else if (msg.sdp && msg.sdp.type === 'answer') {\n      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n    }\n  };\n\n  setupWebRTC = async () => {\n    // Set up our own video\n    const stream = await navigator.mediaDevices.getUserMedia({\n      audio: true,\n      video: true,\n    });\n    this.ourStream = stream;\n    // alert server we've joined video chat\n    this.socket.emit('CMD:joinVideo');\n  };\n\n  stopWebRTC = () => {\n    this.ourStream &&\n      this.ourStream.getTracks().forEach((track) => {\n        track.stop();\n      });\n    this.ourStream = undefined;\n    Object.values(this.videoPCs).forEach((pc) => {\n      pc.close();\n    });\n    this.videoPCs = {};\n    this.socket.emit('CMD:leaveVideo');\n  };\n\n  toggleVideoWebRTC = () => {\n    if (this.ourStream) {\n      this.ourStream.getVideoTracks()[0].enabled = !this.ourStream.getVideoTracks()[0]\n        .enabled;\n    }\n  };\n\n  getVideoWebRTC = () => {\n    return this.ourStream && this.ourStream.getVideoTracks()[0].enabled;\n  };\n\n  toggleAudioWebRTC = () => {\n    if (this.ourStream) {\n      this.ourStream.getAudioTracks()[0].enabled = !this.ourStream.getAudioTracks()[0]\n        .enabled;\n    }\n  };\n\n  getAudioWebRTC = () => {\n    return (\n      this.ourStream &&\n      this.ourStream.getAudioTracks()[0] &&\n      this.ourStream.getAudioTracks()[0].enabled\n    );\n  };\n\n  updateWebRTC = () => {\n    // TODO teardown connections to people who leave\n    if (!this.ourStream) {\n      // We haven't started video chat, exit\n      return;\n    }\n    this.props.participants.forEach((user) => {\n      const id = user.id;\n      if (!user.isVideoChat || this.videoPCs[id]) {\n        return;\n      }\n      if (id === this.socket.id) {\n        this.videoPCs[id] = new RTCPeerConnection();\n        this.videoRefs[id].srcObject = this.ourStream;\n      } else {\n        const pc = new RTCPeerConnection({ iceServers: iceServers() });\n        this.videoPCs[id] = pc;\n        // Add our own video as outgoing stream\n        //@ts-ignore\n        pc.addStream(this.ourStream);\n        pc.onicecandidate = (event) => {\n          // We generated an ICE candidate, send it to peer\n          if (event.candidate) {\n            this.sendSignal(id, { ice: event.candidate });\n          }\n        };\n        //@ts-ignore\n        pc.onaddstream = (event: any) => {\n          // Mount the stream from peer\n          const stream = event.stream;\n          // console.log(stream);\n          this.videoRefs[id].srcObject = stream;\n        };\n        // For each pair, have the lexicographically smaller ID be the offerer\n        const isOfferer = this.socket.id < id;\n        if (isOfferer) {\n          pc.onnegotiationneeded = async () => {\n            // Start connection for peer's video\n            const offer = await pc.createOffer();\n            await pc.setLocalDescription(offer);\n            this.sendSignal(id, { sdp: pc.localDescription });\n          };\n        }\n      }\n    });\n  };\n\n  sendSignal = async (to: string, data: any) => {\n    console.log('send', to, data);\n    this.socket.emit('signal', { to, msg: data });\n  };\n\n  render() {\n    const { participants, pictureMap, nameMap, tsMap, socket } = this.props;\n    return (\n      <div\n        style={{\n          display: this.props.hide ? 'none' : 'flex',\n          width: '100%',\n          flexDirection: 'column',\n          overflow: 'auto',\n        }}\n      >\n        {!this.ourStream && (\n          <div\n            style={{\n              display: 'flex',\n              flexWrap: 'wrap',\n            }}\n          >\n            <Button\n              fluid\n              title=\"Join Video Chat\"\n              color={'purple'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.setupWebRTC}\n            >\n              <Icon name=\"video\" />\n              {`Join Video Chat`}\n            </Button>\n          </div>\n        )}\n        {this.ourStream && (\n          <div\n            style={{\n              display: 'flex',\n              flexWrap: 'wrap',\n            }}\n          >\n            <Button\n              fluid\n              color={'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.stopWebRTC}\n            >\n              <Icon name=\"external\" />\n              {`Leave`}\n            </Button>\n            <Button\n              fluid\n              color={this.getVideoWebRTC() ? 'green' : 'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.toggleVideoWebRTC}\n            >\n              <Icon name=\"video\" />\n              {this.getVideoWebRTC() ? 'On' : 'Off'}\n            </Button>\n            <Button\n              fluid\n              color={this.getAudioWebRTC() ? 'green' : 'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.toggleAudioWebRTC}\n            >\n              <Icon\n                name={this.getAudioWebRTC() ? 'microphone' : 'microphone slash'}\n              />\n              {this.getAudioWebRTC() ? 'On' : 'Off'}\n            </Button>\n          </div>\n        )}\n        <div style={{ display: 'flex', flexWrap: 'wrap' }}>\n          {participants.map((p) => {\n            return (\n              <div key={p.id}>\n                <div\n                  style={{\n                    position: 'relative',\n                    //marginLeft: '4px',\n                  }}\n                >\n                  <div>\n                    {this.ourStream && p.isVideoChat ? (\n                      <video\n                        ref={(el) => {\n                          this.videoRefs[p.id] = el;\n                        }}\n                        className=\"videoChatContent\"\n                        autoPlay\n                        muted={p.id === socket.id}\n                        data-id={p.id}\n                      />\n                    ) : (\n                      <img\n                        className=\"videoChatContent\"\n                        // broken image: https://ui-avatars.com/api/?name=haidee&background=B03060&size=256&color=ffffff\n                        src={\n                          pictureMap[p.id] ||\n                          getDefaultPicture(nameMap[p.id], getColorHex(p.id))\n                        }\n                        alt=\"\"\n                      />\n                    )}\n                    <div\n                      style={{\n                        position: 'absolute',\n                        bottom: '4px',\n                        left: '0px',\n                        width: '100%',\n                        backgroundColor: 'rgba(0,0,0,0)',\n                        color: 'white',\n                        borderRadius: '4px',\n                        fontSize: '10px',\n                        fontWeight: 700,\n                        display: 'flex',\n                      }}\n                    >\n                      <div\n                        title={nameMap[p.id] || p.id}\n                        style={{\n                          width: '80px',\n                          backdropFilter: 'brightness(80%)',\n                          padding: '4px',\n                          textOverflow: 'ellipsis',\n                          whiteSpace: 'nowrap',\n                          overflow: 'hidden',\n                          display: 'inline-block',\n                        }}\n                      >\n                        {p.isVideoChat && <Icon size=\"small\" name=\"video\" />}\n                        {nameMap[p.id] || p.id}\n                      </div>\n                      <div\n                        style={{\n                          backdropFilter: 'brightness(60%)',\n                          padding: '4px',\n                          flexGrow: 1,\n                          display: 'flex',\n                          justifyContent: 'center',\n                        }}\n                      >\n                        {formatTimestamp(tsMap[p.id] || 0)}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}