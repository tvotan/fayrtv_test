{"ast":null,"code":"import _objectWithoutProperties from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";import _objectSpread from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";var _EVENT$MESSAGE,_EVENT$CONNECTING,_EVENT$CONNECTED,_EVENT$DISCONNECTED,_EVENT$TRACK,_EVENT$DATA;import EventEmitter from'eventemitter3';import{iceServers}from'../../utils';import{OPCODE}from'./data';import{EVENT}from'./events';_EVENT$MESSAGE=EVENT.MESSAGE;_EVENT$CONNECTING=EVENT.CONNECTING;_EVENT$CONNECTED=EVENT.CONNECTED;_EVENT$DISCONNECTED=EVENT.DISCONNECTED;_EVENT$TRACK=EVENT.TRACK;_EVENT$DATA=EVENT.DATA;export var BaseClient=/*#__PURE__*/function(_EventEmitter){_inherits(BaseClient,_EventEmitter);var _super=_createSuper(BaseClient);function BaseClient(){var _this;_classCallCheck(this,BaseClient);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this._ws=void 0;_this._peer=void 0;_this._channel=void 0;_this._timeout=void 0;_this._displayname=void 0;_this._state='disconnected';_this._id='';return _this;}_createClass(BaseClient,[{key:\"connect\",value:function connect(url,password,displayname){var _this2=this;if(this.socketOpen){this.emit('warn',\"attempting to create websocket while connection open\");return;}if(!this.supported){this.onDisconnected(new Error('browser does not support webrtc (RTCPeerConnection missing)'));return;}if(displayname===''){throw new Error('Must add a displayname');}this._displayname=displayname;this[EVENT.CONNECTING]();try{this._ws=new WebSocket(\"\".concat(url,\"ws?password=\").concat(password));this.emit('debug',\"connecting to \".concat(this._ws.url));this._ws.onmessage=this.onMessage.bind(this);this._ws.onerror=function(event){return _this2.onError.bind(_this2);};this._ws.onclose=function(event){return _this2.onDisconnected.bind(_this2,new Error('websocket closed'));};this._timeout=setTimeout(this.onTimeout.bind(this),15000);}catch(err){this.onDisconnected(err);}}},{key:\"disconnect\",value:function disconnect(){if(this._timeout){clearTimeout(this._timeout);}if(this.socketOpen){try{this._ws.close();}catch(err){}this._ws=undefined;}if(this.peerConnected){try{this._peer.close();}catch(err){}this._peer=undefined;}this._state='disconnected';this._displayname=undefined;this._id='';}},{key:\"sendData\",value:function sendData(event,data){if(!this.connected){this.emit('warn',\"attempting to send data while disconnected\");return;}var buffer;var payload;switch(event){case'mousemove':buffer=new ArrayBuffer(7);payload=new DataView(buffer);payload.setUint8(0,OPCODE.MOVE);payload.setUint16(1,4,true);payload.setUint16(3,data.x,true);payload.setUint16(5,data.y,true);break;case'wheel':buffer=new ArrayBuffer(7);payload=new DataView(buffer);payload.setUint8(0,OPCODE.SCROLL);payload.setUint16(1,4,true);payload.setInt16(3,data.x,true);payload.setInt16(5,data.y,true);break;case'keydown':case'mousedown':buffer=new ArrayBuffer(5);payload=new DataView(buffer);payload.setUint8(0,OPCODE.KEY_DOWN);payload.setUint16(1,1,true);payload.setUint16(3,data.key,true);break;case'keyup':case'mouseup':buffer=new ArrayBuffer(5);payload=new DataView(buffer);payload.setUint8(0,OPCODE.KEY_UP);payload.setUint16(1,1,true);payload.setUint16(3,data.key,true);break;default:this.emit('warn',\"unknown data event: \".concat(event));}// @ts-ignore\nif(typeof buffer!=='undefined'){this._channel.send(buffer);}}},{key:\"sendMessage\",value:function sendMessage(event,payload){if(!this.connected){this.emit('warn',\"attempting to send message while disconnected\");return;}this.emit('debug',\"sending event '\".concat(event,\"' \").concat(payload?\"with payload: \":''),payload);this._ws.send(JSON.stringify(_objectSpread({event:event},payload)));}},{key:\"createPeer\",value:function createPeer(sdp,lite,servers){var _this3=this;this.emit('debug',\"creating peer\");if(!this.socketOpen){this.emit('warn',\"attempting to create peer with no websocket: \",this._ws?\"state: \".concat(this._ws.readyState):'no socket');return;}if(this.peerConnected){this.emit('warn',\"attempting to create peer while connected\");return;}this._peer=new RTCPeerConnection();if(lite!==true){this._peer=new RTCPeerConnection({iceServers:servers?[{urls:servers}]:iceServers()});}this._peer.onconnectionstatechange=function(event){_this3.emit('debug',\"peer connection state changed\",_this3._peer?_this3._peer.connectionState:undefined);};this._peer.onsignalingstatechange=function(event){_this3.emit('debug',\"peer signaling state changed\",_this3._peer?_this3._peer.signalingState:undefined);};this._peer.oniceconnectionstatechange=function(event){_this3._state=_this3._peer.iceConnectionState;_this3.emit('debug',\"peer ice connection state changed: \".concat(_this3._peer.iceConnectionState));switch(_this3._state){case'checking':if(_this3._timeout){clearTimeout(_this3._timeout);}break;case'connected':_this3.onConnected();break;case'failed':_this3.onDisconnected(new Error('peer failed'));break;case'disconnected':_this3.onDisconnected(new Error('peer disconnected'));break;}};this._peer.ontrack=this.onTrack.bind(this);this._peer.addTransceiver('audio',{direction:'recvonly'});this._peer.addTransceiver('video',{direction:'recvonly'});this._channel=this._peer.createDataChannel('data');this._channel.onerror=this.onError.bind(this);this._channel.onmessage=this.onData.bind(this);this._channel.onclose=this.onDisconnected.bind(this,new Error('peer data channel closed'));this._peer.setRemoteDescription({type:'offer',sdp:sdp});this._peer.createAnswer().then(function(d){_this3._peer.setLocalDescription(d);_this3._ws.send(JSON.stringify({event:EVENT.SIGNAL.ANSWER,sdp:d.sdp,displayname:_this3._displayname}));}).catch(function(err){return _this3.emit('error',err);});}},{key:\"onMessage\",value:function onMessage(e){var _ref=JSON.parse(e.data),event=_ref.event,payload=_objectWithoutProperties(_ref,[\"event\"]);this.emit('debug',\"received websocket event \".concat(event,\" \").concat(payload?\"with payload: \":''),payload);if(event===EVENT.SIGNAL.PROVIDE){var _ref2=payload,sdp=_ref2.sdp,lite=_ref2.lite,ice=_ref2.ice,id=_ref2.id;this._id=id;this.createPeer(sdp,lite,ice);return;}// @ts-ignore\nif(typeof this[event]==='function'){// @ts-ignore\nthis[event](payload);}else{this[EVENT.MESSAGE](event,payload);}}},{key:\"onData\",value:function onData(e){this[EVENT.DATA](e.data);}},{key:\"onTrack\",value:function onTrack(event){this.emit('debug',\"received \".concat(event.track.kind,\" track from peer: \").concat(event.track.id),event);var stream=event.streams[0];if(!stream){this.emit('warn',\"no stream provided for track \".concat(event.track.id,\"(\").concat(event.track.label,\")\"));return;}this[EVENT.TRACK](event);}},{key:\"onError\",value:function onError(event){this.emit('error',event.error);}},{key:\"onConnected\",value:function onConnected(){if(this._timeout){clearTimeout(this._timeout);}if(!this.connected){this.emit('warn',\"onConnected called while being disconnected\");return;}this.emit('debug',\"connected\");this[EVENT.CONNECTED]();}},{key:\"onTimeout\",value:function onTimeout(){this.emit('debug',\"connection timeout\");if(this._timeout){clearTimeout(this._timeout);}this.onDisconnected(new Error('connection timeout'));}},{key:\"onDisconnected\",value:function onDisconnected(reason){this.disconnect();this.emit('debug',\"disconnected:\",reason);this[EVENT.DISCONNECTED](reason);}},{key:_EVENT$MESSAGE,value:function value(event,payload){this.emit('warn',\"unhandled websocket event '\".concat(event,\"':\"),payload);}},{key:\"id\",get:function get(){return this._id;}},{key:\"supported\",get:function get(){return typeof RTCPeerConnection!=='undefined'&&typeof RTCPeerConnection.prototype.addTransceiver!=='undefined';}},{key:\"socketOpen\",get:function get(){return typeof this._ws!=='undefined'&&this._ws.readyState===WebSocket.OPEN;}},{key:\"peerConnected\",get:function get(){return typeof this._peer!=='undefined'&&['connected','checking','completed'].includes(this._state);}},{key:\"connected\",get:function get(){return this.peerConnected&&this.socketOpen;}}]);return BaseClient;}(EventEmitter);","map":{"version":3,"sources":["/Users/tinvotan/Projects/fayrtv/fayr_test/fayrtv_test/src/components/VBrowser/base.ts"],"names":["EventEmitter","iceServers","OPCODE","EVENT","MESSAGE","CONNECTING","CONNECTED","DISCONNECTED","TRACK","DATA","BaseClient","_ws","_peer","_channel","_timeout","_displayname","_state","_id","url","password","displayname","socketOpen","emit","supported","onDisconnected","Error","WebSocket","onmessage","onMessage","bind","onerror","event","onError","onclose","setTimeout","onTimeout","err","clearTimeout","close","undefined","peerConnected","data","connected","buffer","payload","ArrayBuffer","DataView","setUint8","MOVE","setUint16","x","y","SCROLL","setInt16","KEY_DOWN","key","KEY_UP","send","JSON","stringify","sdp","lite","servers","readyState","RTCPeerConnection","urls","onconnectionstatechange","connectionState","onsignalingstatechange","signalingState","oniceconnectionstatechange","iceConnectionState","onConnected","ontrack","onTrack","addTransceiver","direction","createDataChannel","onData","setRemoteDescription","type","createAnswer","then","d","setLocalDescription","SIGNAL","ANSWER","catch","e","parse","PROVIDE","ice","id","createPeer","track","kind","stream","streams","label","error","reason","disconnect","prototype","OPEN","includes"],"mappings":"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","sourcesContent":["import EventEmitter from 'eventemitter3';\n\nimport { iceServers } from '../../utils';\nimport { OPCODE } from './data';\nimport { EVENT, WebSocketEvents } from './events';\nimport {\n  SignalProvidePayload,\n  WebSocketMessages,\n  WebSocketPayloads,\n} from './messages';\n\nexport abstract class BaseClient extends EventEmitter<any> {\n  protected _ws?: WebSocket;\n  protected _peer?: RTCPeerConnection;\n  protected _channel?: RTCDataChannel;\n  protected _timeout?: NodeJS.Timeout;\n  protected _displayname?: string;\n  protected _state: RTCIceConnectionState = 'disconnected';\n  protected _id = '';\n\n  get id() {\n    return this._id;\n  }\n\n  get supported() {\n    return (\n      typeof RTCPeerConnection !== 'undefined' &&\n      typeof RTCPeerConnection.prototype.addTransceiver !== 'undefined'\n    );\n  }\n\n  get socketOpen() {\n    return (\n      typeof this._ws !== 'undefined' && this._ws.readyState === WebSocket.OPEN\n    );\n  }\n\n  get peerConnected() {\n    return (\n      typeof this._peer !== 'undefined' &&\n      ['connected', 'checking', 'completed'].includes(this._state)\n    );\n  }\n\n  get connected() {\n    return this.peerConnected && this.socketOpen;\n  }\n\n  public connect(url: string, password: string, displayname: string) {\n    if (this.socketOpen) {\n      this.emit('warn', `attempting to create websocket while connection open`);\n      return;\n    }\n\n    if (!this.supported) {\n      this.onDisconnected(\n        new Error('browser does not support webrtc (RTCPeerConnection missing)')\n      );\n      return;\n    }\n\n    if (displayname === '') {\n      throw new Error('Must add a displayname');\n    }\n\n    this._displayname = displayname;\n    this[EVENT.CONNECTING]();\n\n    try {\n      this._ws = new WebSocket(`${url}ws?password=${password}`);\n      this.emit('debug', `connecting to ${this._ws.url}`);\n      this._ws.onmessage = this.onMessage.bind(this);\n      this._ws.onerror = (event) => this.onError.bind(this);\n      this._ws.onclose = (event) =>\n        this.onDisconnected.bind(this, new Error('websocket closed'));\n      this._timeout = setTimeout(this.onTimeout.bind(this), 15000);\n    } catch (err) {\n      this.onDisconnected(err);\n    }\n  }\n\n  protected disconnect() {\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n    }\n\n    if (this.socketOpen) {\n      try {\n        this._ws!.close();\n      } catch (err) {}\n      this._ws = undefined;\n    }\n\n    if (this.peerConnected) {\n      try {\n        this._peer!.close();\n      } catch (err) {}\n      this._peer = undefined;\n    }\n\n    this._state = 'disconnected';\n    this._displayname = undefined;\n    this._id = '';\n  }\n\n  public sendData(\n    event: 'wheel' | 'mousemove',\n    data: { x: number; y: number }\n  ): void;\n  public sendData(\n    event: 'mousedown' | 'mouseup' | 'keydown' | 'keyup',\n    data: { key: number }\n  ): void;\n  public sendData(event: string, data: any) {\n    if (!this.connected) {\n      this.emit('warn', `attempting to send data while disconnected`);\n      return;\n    }\n\n    let buffer: ArrayBuffer;\n    let payload: DataView;\n    switch (event) {\n      case 'mousemove':\n        buffer = new ArrayBuffer(7);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.MOVE);\n        payload.setUint16(1, 4, true);\n        payload.setUint16(3, data.x, true);\n        payload.setUint16(5, data.y, true);\n        break;\n      case 'wheel':\n        buffer = new ArrayBuffer(7);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.SCROLL);\n        payload.setUint16(1, 4, true);\n        payload.setInt16(3, data.x, true);\n        payload.setInt16(5, data.y, true);\n        break;\n      case 'keydown':\n      case 'mousedown':\n        buffer = new ArrayBuffer(5);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.KEY_DOWN);\n        payload.setUint16(1, 1, true);\n        payload.setUint16(3, data.key, true);\n        break;\n      case 'keyup':\n      case 'mouseup':\n        buffer = new ArrayBuffer(5);\n        payload = new DataView(buffer);\n        payload.setUint8(0, OPCODE.KEY_UP);\n        payload.setUint16(1, 1, true);\n        payload.setUint16(3, data.key, true);\n        break;\n      default:\n        this.emit('warn', `unknown data event: ${event}`);\n    }\n\n    // @ts-ignore\n    if (typeof buffer !== 'undefined') {\n      this._channel!.send(buffer);\n    }\n  }\n\n  public sendMessage(event: WebSocketEvents, payload?: WebSocketPayloads) {\n    if (!this.connected) {\n      this.emit('warn', `attempting to send message while disconnected`);\n      return;\n    }\n    this.emit(\n      'debug',\n      `sending event '${event}' ${payload ? `with payload: ` : ''}`,\n      payload\n    );\n    this._ws!.send(JSON.stringify({ event, ...payload }));\n  }\n\n  public createPeer(sdp: string, lite: boolean, servers: string[]) {\n    this.emit('debug', `creating peer`);\n    if (!this.socketOpen) {\n      this.emit(\n        'warn',\n        `attempting to create peer with no websocket: `,\n        this._ws ? `state: ${this._ws.readyState}` : 'no socket'\n      );\n      return;\n    }\n\n    if (this.peerConnected) {\n      this.emit('warn', `attempting to create peer while connected`);\n      return;\n    }\n\n    this._peer = new RTCPeerConnection();\n    if (lite !== true) {\n      this._peer = new RTCPeerConnection({\n        iceServers: servers ? [{ urls: servers }] : iceServers(),\n      });\n    }\n\n    this._peer.onconnectionstatechange = (event) => {\n      this.emit(\n        'debug',\n        `peer connection state changed`,\n        this._peer ? this._peer.connectionState : undefined\n      );\n    };\n\n    this._peer.onsignalingstatechange = (event) => {\n      this.emit(\n        'debug',\n        `peer signaling state changed`,\n        this._peer ? this._peer.signalingState : undefined\n      );\n    };\n\n    this._peer.oniceconnectionstatechange = (event) => {\n      this._state = this._peer!.iceConnectionState;\n\n      this.emit(\n        'debug',\n        `peer ice connection state changed: ${this._peer!.iceConnectionState}`\n      );\n\n      switch (this._state) {\n        case 'checking':\n          if (this._timeout) {\n            clearTimeout(this._timeout);\n          }\n          break;\n        case 'connected':\n          this.onConnected();\n          break;\n        case 'failed':\n          this.onDisconnected(new Error('peer failed'));\n          break;\n        case 'disconnected':\n          this.onDisconnected(new Error('peer disconnected'));\n          break;\n      }\n    };\n\n    this._peer.ontrack = this.onTrack.bind(this);\n    this._peer.addTransceiver('audio', { direction: 'recvonly' });\n    this._peer.addTransceiver('video', { direction: 'recvonly' });\n\n    this._channel = this._peer.createDataChannel('data');\n    this._channel.onerror = this.onError.bind(this);\n    this._channel.onmessage = this.onData.bind(this);\n    this._channel.onclose = this.onDisconnected.bind(\n      this,\n      new Error('peer data channel closed')\n    );\n\n    this._peer.setRemoteDescription({ type: 'offer', sdp });\n    this._peer\n      .createAnswer()\n      .then((d) => {\n        this._peer!.setLocalDescription(d);\n        this._ws!.send(\n          JSON.stringify({\n            event: EVENT.SIGNAL.ANSWER,\n            sdp: d.sdp,\n            displayname: this._displayname,\n          })\n        );\n      })\n      .catch((err) => this.emit('error', err));\n  }\n\n  private onMessage(e: MessageEvent) {\n    const { event, ...payload } = JSON.parse(e.data) as WebSocketMessages;\n\n    this.emit(\n      'debug',\n      `received websocket event ${event} ${payload ? `with payload: ` : ''}`,\n      payload\n    );\n\n    if (event === EVENT.SIGNAL.PROVIDE) {\n      const { sdp, lite, ice, id } = payload as SignalProvidePayload;\n      this._id = id;\n      this.createPeer(sdp, lite, ice);\n      return;\n    }\n\n    // @ts-ignore\n    if (typeof this[event] === 'function') {\n      // @ts-ignore\n      this[event](payload);\n    } else {\n      this[EVENT.MESSAGE](event, payload);\n    }\n  }\n\n  private onData(e: MessageEvent) {\n    this[EVENT.DATA](e.data);\n  }\n\n  private onTrack(event: RTCTrackEvent) {\n    this.emit(\n      'debug',\n      `received ${event.track.kind} track from peer: ${event.track.id}`,\n      event\n    );\n    const stream = event.streams[0];\n    if (!stream) {\n      this.emit(\n        'warn',\n        `no stream provided for track ${event.track.id}(${event.track.label})`\n      );\n      return;\n    }\n    this[EVENT.TRACK](event);\n  }\n\n  private onError(event: Event) {\n    this.emit('error', (event as ErrorEvent).error);\n  }\n\n  private onConnected() {\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n    }\n\n    if (!this.connected) {\n      this.emit('warn', `onConnected called while being disconnected`);\n      return;\n    }\n\n    this.emit('debug', `connected`);\n    this[EVENT.CONNECTED]();\n  }\n\n  private onTimeout() {\n    this.emit('debug', `connection timeout`);\n    if (this._timeout) {\n      clearTimeout(this._timeout);\n    }\n    this.onDisconnected(new Error('connection timeout'));\n  }\n\n  protected onDisconnected(reason?: Error) {\n    this.disconnect();\n    this.emit('debug', `disconnected:`, reason);\n    this[EVENT.DISCONNECTED](reason);\n  }\n\n  protected [EVENT.MESSAGE](event: string, payload: any) {\n    this.emit('warn', `unhandled websocket event '${event}':`, payload);\n  }\n\n  protected abstract [EVENT.CONNECTING](): void;\n  protected abstract [EVENT.CONNECTED](): void;\n  protected abstract [EVENT.DISCONNECTED](reason?: Error): void;\n  protected abstract [EVENT.TRACK](event: RTCTrackEvent): void;\n  protected abstract [EVENT.DATA](data: any): void;\n}\n"]},"metadata":{},"sourceType":"module"}